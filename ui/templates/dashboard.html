{% extends "base.html" %}

{% block title %}AI Models Dashboard - Deep Learning System{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        min-height: 100vh;
        color: #333;
    }

    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Header */
    .header {
        background: white;
        border-radius: 12px;
        padding: 20px 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-left h1 {
        font-size: 24px;
        color: #1e3c72;
        margin-bottom: 5px;
    }

    .header-left p {
        color: #6c757d;
        font-size: 14px;
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 15px;
        background: #f8f9fa;
        border-radius: 20px;
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
    }

    .user-name {
        font-weight: 500;
        color: #333;
    }

    .logout-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .logout-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
    }

    .admin-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .admin-btn:hover {
        background: #218838;
        transform: translateY(-1px);
    }

    /* User Management Panel */
    .user-management-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    .user-management-overlay.active {
        display: flex;
    }

    .user-management-panel {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 1000px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .panel-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .panel-header h2 {
        font-size: 22px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .close-panel-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.2s;
    }

    .close-panel-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }

    .panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 30px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }

    .stat-card.green {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .stat-card.orange {
        background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
    }

    .stat-card.blue {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }

    .stat-number {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }

    .users-table-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }

    .users-table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .users-table-header h3 {
        font-size: 18px;
        color: #333;
    }

    .search-user-input {
        padding: 8px 15px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 14px;
        width: 250px;
    }

    .users-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .users-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .users-table th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        font-size: 14px;
    }

    .users-table td {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        color: #333;
        font-size: 14px;
    }

    .users-table tr:hover {
        background: #f8f9fa;
    }

    .user-avatar-small {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
        margin-right: 10px;
        vertical-align: middle;
    }

    .role-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .role-badge.admin {
        background: #dc3545;
        color: white;
    }

    .role-badge.user {
        background: #28a745;
        color: white;
    }

    .action-btn {
        padding: 5px 12px;
        border: none;
        border-radius: 5px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        margin-right: 5px;
    }

    .action-btn.edit {
        background: #007bff;
        color: white;
    }

    .action-btn.edit:hover {
        background: #0056b3;
    }

    .action-btn.delete {
        background: #dc3545;
        color: white;
    }

    .action-btn.delete:hover {
        background: #c82333;
    }

    /* Models Grid */
    .models-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }

    .model-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .model-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .model-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .model-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .model-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .model-icon.model1 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .model-icon.model2 {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .model-title h2 {
        font-size: 20px;
        color: #333;
        margin-bottom: 3px;
    }

    .model-title p {
        font-size: 13px;
        color: #6c757d;
    }

    .model-status {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        background: #d4edda;
        color: #155724;
    }

    /* Input Section */
    .input-section {
        margin-bottom: 20px;
    }

    .input-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 8px;
        display: block;
    }

    .input-field, .input-textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
        font-family: inherit;
    }

    .input-field:focus, .input-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .input-textarea {
        resize: vertical;
        min-height: 120px;
    }

    .input-file {
        display: none;
    }

    .file-upload-btn {
        display: inline-block;
        padding: 12px 24px;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        width: 100%;
    }

    .file-upload-btn:hover {
        background: #e9ecef;
        border-color: #667eea;
    }

    .file-name {
        margin-top: 8px;
        font-size: 13px;
        color: #6c757d;
        font-style: italic;
    }

    /* Prediction Button */
    .predict-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .predict-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .predict-btn:active {
        transform: translateY(0);
    }

    .predict-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Results Section */
    .results-section {
        margin-top: 25px;
        padding-top: 25px;
        border-top: 2px solid #f0f0f0;
    }

    .results-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        font-size: 16px;
    }

    .result-box {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        min-height: 100px;
        border-left: 4px solid #667eea;
    }

    .result-text {
        font-size: 14px;
        line-height: 1.6;
        color: #333;
    }

    .no-result {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 30px;
    }

    /* Loading Spinner */
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Dataset Info */
    .dataset-info {
        background: #e7f3ff;
        border-left: 4px solid #0066cc;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }

    .dataset-info h3 {
        font-size: 14px;
        color: #0066cc;
        margin-bottom: 8px;
    }

    .dataset-info ul {
        list-style: none;
        padding-left: 0;
        font-size: 13px;
        color: #333;
    }

    .dataset-info li {
        padding: 4px 0;
        padding-left: 20px;
        position: relative;
    }

    .dataset-info li:before {
        content: "‚Ä¢";
        position: absolute;
        left: 5px;
        color: #0066cc;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .models-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .header-right {
            width: 100%;
            justify-content: space-between;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>üß† Deep Learning Models Dashboard</h1>
            <p>H·ªá th·ªëng d·ª± ƒëo√°n vƒÉn b·∫£n v√† nh·∫≠n di·ªán k√Ω t·ª±</p>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="user-avatar">{{ user.first_name[0].upper() if user.first_name else 'U' }}</div>
                <span class="user-name">
                    {{ user.first_name }} {{ user.last_name }}
                    {% if user.role == 'admin' %}
                        <span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px;">ADMIN</span>
                    {% endif %}
                </span>
            </div>
            {% if user.role == 'admin' %}
            <button class="admin-btn" onclick="toggleUserManagement()">
                <i class="fas fa-users-cog"></i>
                Qu·∫£n l√Ω User
            </button>
            {% endif %}
            <a href="{{ url_for('auth.logout') }}" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </div>

    <!-- Models Grid -->
    <div class="models-grid">
        <!-- MODEL 1: H√≥a ƒë∆°n ƒëi·ªán t·ª≠ + D·ª± ƒëo√°n s·ªë l∆∞·ª£ng -->
        <div class="model-card">
            <div class="model-header">
                <div class="model-title">
                    <div class="model-icon model1">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div>
                        <h2>MODEL 1: H√≥a ƒë∆°n ƒëi·ªán t·ª≠</h2>
                        <p>D·ª± ƒëo√°n s·ªë l∆∞·ª£ng k·∫ø ti·∫øp</p>
                    </div>
                </div>
                <span class="model-status">
                    <i class="fas fa-check-circle"></i> Ready
                </span>
            </div>

            <div class="input-section">
                <label class="input-label">
                    <i class="fas fa-keyboard"></i> Nh·∫≠p h√≥a ƒë∆°n (danh s√°ch s·∫£n ph·∫©m)
                </label>
                <textarea 
                    class="input-textarea" 
                    id="model1Input"
                    placeholder="Nh·∫≠p danh s√°ch h√≥a ƒë∆°n&#10;V√≠ d·ª•:&#10;H√≥a ƒë∆°n gi√†y qu·∫≠n S∆°n&#10;H√≥a ƒë∆°n gi√†y qu·∫≠n T√πng"
                ></textarea>
            </div>

            <button class="predict-btn" onclick="predictModel1()">
                <i class="fas fa-brain"></i>
                D·ª± ƒëo√°n s·ªë l∆∞·ª£ng k·∫ø ti·∫øp
            </button>

            <div class="results-section">
                <div class="results-title">
                    <i class="fas fa-chart-line"></i> K·∫øt qu·∫£ d·ª± ƒëo√°n:
                </div>
                <div class="result-box" id="model1Result">
                    <div class="no-result">Ch∆∞a c√≥ k·∫øt qu·∫£. Nh·∫≠p d·ªØ li·ªáu v√† nh·∫•n d·ª± ƒëo√°n.</div>
                </div>
            </div>

            <div class="dataset-info">
                <h3><i class="fas fa-database"></i> Dataset th√¥ng tin:</h3>
                <ul>
                    <li>Danh s√°ch s·∫£n ph·∫©m qu·∫≠n S∆°n, T√πng</li>
                    <li>H√≥a ƒë∆°n ƒëi·ªán t·ª≠ + gi·∫•y qu·∫≠n T√πng</li>
                    <li>70% train, 10% valid, 20% test</li>
                </ul>
            </div>
        </div>

        <!-- MODEL 2: Text Recognition -->
        <div class="model-card">
            <div class="model-header">
                <div class="model-title">
                    <div class="model-icon model2">
                        <i class="fas fa-image"></i>
                    </div>
                    <div>
                        <h2>MODEL 2: Text Recognition</h2>
                        <p>Nh·∫≠n di·ªán k√Ω t·ª± t·ª´ ·∫£nh</p>
                    </div>
                </div>
                <span class="model-status">
                    <i class="fas fa-check-circle"></i> Ready
                </span>
            </div>

            <div class="input-section">
                <label class="input-label">
                    <i class="fas fa-upload"></i> T·∫£i ·∫£nh l√™n
                </label>
                <label for="imageUpload" class="file-upload-btn">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Click ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y
                </label>
                <input 
                    type="file" 
                    id="imageUpload" 
                    class="input-file" 
                    accept="image/*"
                    onchange="handleFileSelect(event)"
                >
                <div class="file-name" id="fileName"></div>
            </div>

            <div class="input-section" style="margin-top: 15px;">
                <label class="input-label">
                    <i class="fas fa-image"></i> Preview ·∫£nh
                </label>
                <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 150px; display: flex; align-items: center; justify-content: center;">
                    <img id="imagePreview" style="max-width: 100%; max-height: 300px; display: none; border-radius: 8px;">
                    <div id="noImageText" style="color: #6c757d; font-style: italic;">
                        <i class="fas fa-image" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 10px;"></i>
                        Ch∆∞a c√≥ ·∫£nh
                    </div>
                </div>
            </div>

            <button class="predict-btn" onclick="predictModel2()" id="model2Btn" disabled>
                <i class="fas fa-eye"></i>
                Nh·∫≠n di·ªán vƒÉn b·∫£n
            </button>

            <div class="results-section">
                <div class="results-title">
                    <i class="fas fa-text-width"></i> VƒÉn b·∫£n nh·∫≠n di·ªán:
                </div>
                <div class="result-box" id="model2Result">
                    <div class="no-result">Ch∆∞a c√≥ k·∫øt qu·∫£. T·∫£i ·∫£nh l√™n v√† nh·∫•n nh·∫≠n di·ªán.</div>
                </div>
            </div>

            <div class="dataset-info">
                <h3><i class="fas fa-database"></i> Dataset th√¥ng tin:</h3>
                <ul>
                    <li>H√≥a ƒë∆°n c≈©: h√≥a ƒë∆°n c√≥ trong dataset</li>
                    <li>H√≥a ƒë∆°n m·ªõi: ch∆∞a c√≥ trong dataset</li>
                    <li>S·ª≠ d·ª•ng HPC ‚Üí HDM</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- User Management Panel (Admin Only) -->
    {% if user.role == 'admin' %}
    <div class="user-management-overlay" id="userManagementOverlay">
        <div class="user-management-panel">
            <div class="panel-header">
                <h2>
                    <i class="fas fa-users-cog"></i>
                    Qu·∫£n l√Ω ng∆∞·ªùi d√πng
                </h2>
                <button class="close-panel-btn" onclick="toggleUserManagement()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="panel-content">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">T·ªïng ng∆∞·ªùi d√πng</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">Ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-number" id="adminUsers">0</div>
                        <div class="stat-label">Qu·∫£n tr·ªã vi√™n</div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="users-table-container">
                    <div class="users-table-header">
                        <h3><i class="fas fa-list"></i> Danh s√°ch ng∆∞·ªùi d√πng</h3>
                        <input 
                            type="text" 
                            class="search-user-input" 
                            placeholder="üîç T√¨m ki·∫øm ng∆∞·ªùi d√πng..."
                            id="searchUserInput"
                            oninput="filterUsers()"
                        >
                    </div>
                    
                    <div class="users-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ng∆∞·ªùi d√πng</th>
                                    <th>Email</th>
                                    <th>Vai tr√≤</th>
                                    <th>Ng√†y t·∫°o</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                                        <p style="margin-top: 10px;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- User Activity Table -->
                <div class="users-table-container" style="margin-top: 30px;">
                    <div class="users-table-header">
                        <h3><i class="fas fa-chart-line"></i> L∆∞·ª£ng truy c·∫≠p & Ho·∫°t ƒë·ªông</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="activityFilter" class="search-user-input" style="width: 180px;" onchange="filterActivity()">
                                <option value="all">T·∫•t c·∫£</option>
                                <option value="today">H√¥m nay</option>
                                <option value="week">7 ng√†y qua</option>
                                <option value="month">30 ng√†y qua</option>
                            </select>
                            <button class="action-btn edit" onclick="refreshActivity()" style="padding: 8px 15px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="users-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ng∆∞·ªùi d√πng</th>
                                    <th>Email</th>
                                    <th><i class="fas fa-sign-in-alt"></i> S·ªë l·∫ßn ƒëƒÉng nh·∫≠p</th>
                                    <th><i class="fas fa-brain"></i> L·∫ßn d√πng Model 1</th>
                                    <th><i class="fas fa-image"></i> L·∫ßn d√πng Model 2</th>
                                    <th><i class="fas fa-clock"></i> Truy c·∫≠p cu·ªëi</th>
                                    <th>Tr·∫°ng th√°i</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                                        <p style="margin-top: 10px;">ƒêang t·∫£i d·ªØ li·ªáu ho·∫°t ƒë·ªông...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Model 1: Text Prediction
async function predictModel1() {
    const input = document.getElementById('model1Input').value.trim();
    const resultBox = document.getElementById('model1Result');
    
    if (!input) {
        resultBox.innerHTML = '<div class="no-result">Vui l√≤ng nh·∫≠p d·ªØ li·ªáu h√≥a ƒë∆°n.</div>';
        return;
    }
    
    // Show loading
    resultBox.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #6c757d;">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</p>
        </div>
    `;
    
    try {
        // Simulate API call - Replace with actual API endpoint
        const response = await fetch('/api/model1/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ text: input })
        });
        
        if (response.ok) {
            const data = await response.json();
            displayModel1Result(data);
        } else {
            throw new Error('Prediction failed');
        }
    } catch (error) {
        console.error('Error:', error);
        // Show mock result for demonstration
        setTimeout(() => {
            const mockResult = {
                output1: "H√≥a ƒë∆°n nh·∫≠p ƒëi·ªán t·ª≠: 350 ƒë∆°n v·ªã",
                output2: "D·ª± ƒëo√°n s·ªë l∆∞·ª£ng k·∫ø ti·∫øp: 420 ƒë∆°n v·ªã",
                confidence: 0.89
            };
            displayModel1Result(mockResult);
        }, 1500);
    }
}

function displayModel1Result(data) {
    const resultBox = document.getElementById('model1Result');
    resultBox.innerHTML = `
        <div class="result-text">
            <strong style="color: #667eea;">Output 1:</strong> ${data.output1}<br>
            <strong style="color: #f5576c;">Output 2:</strong> ${data.output2}<br>
            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px; font-size: 13px;">
                <strong>ƒê·ªô tin c·∫≠y:</strong> 
                <span style="color: #28a745; font-weight: 600;">${(data.confidence * 100).toFixed(1)}%</span>
            </div>
        </div>
    `;
}

// Model 2: Text Recognition
let selectedFile = null;

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
        selectedFile = file;
        
        // Show file name
        document.getElementById('fileName').textContent = `üìé ${file.name}`;
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('imagePreview');
            const noImageText = document.getElementById('noImageText');
            preview.src = e.target.result;
            preview.style.display = 'block';
            noImageText.style.display = 'none';
        };
        reader.readAsDataURL(file);
        
        // Enable button
        document.getElementById('model2Btn').disabled = false;
    }
}

async function predictModel2() {
    if (!selectedFile) {
        alert('Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc!');
        return;
    }
    
    const resultBox = document.getElementById('model2Result');
    
    // Show loading
    resultBox.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #6c757d;">ƒêang nh·∫≠n di·ªán vƒÉn b·∫£n...</p>
        </div>
    `;
    
    try {
        // Prepare form data
        const formData = new FormData();
        formData.append('image', selectedFile);
        
        // Simulate API call - Replace with actual API endpoint
        const response = await fetch('/api/model2/recognize', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const data = await response.json();
            displayModel2Result(data);
        } else {
            throw new Error('Recognition failed');
        }
    } catch (error) {
        console.error('Error:', error);
        // Show mock result for demonstration
        setTimeout(() => {
            const mockResult = {
                recognized_text: "Y1 hoa don dien tu nhap hang\nY2 TEXT: H√≥a ƒë∆°n s·ªë 12345\nS·ªë l∆∞·ª£ng: 150 ƒë∆°n v·ªã\nT·ªïng ti·ªÅn: 4.500.000 VNƒê",
                confidence: 0.92
            };
            displayModel2Result(mockResult);
        }, 2000);
    }
}

function displayModel2Result(data) {
    const resultBox = document.getElementById('model2Result');
    resultBox.innerHTML = `
        <div class="result-text">
            <div style="white-space: pre-wrap; line-height: 1.8;">
                ${data.recognized_text}
            </div>
            <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px; font-size: 13px;">
                <strong>ƒê·ªô tin c·∫≠y:</strong> 
                <span style="color: #28a745; font-weight: 600;">${(data.confidence * 100).toFixed(1)}%</span>
            </div>
        </div>
    `;
}

// Drag and drop support
const fileUploadBtn = document.querySelector('.file-upload-btn');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    fileUploadBtn.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    fileUploadBtn.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    fileUploadBtn.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    fileUploadBtn.style.borderColor = '#667eea';
    fileUploadBtn.style.background = '#e7f3ff';
}

function unhighlight(e) {
    fileUploadBtn.style.borderColor = '#dee2e6';
    fileUploadBtn.style.background = '#f8f9fa';
}

fileUploadBtn.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        document.getElementById('imageUpload').files = files;
        handleFileSelect({ target: { files: files } });
    }
}

// User Management Functions (Admin Only)
let allUsersData = [];
let allActivityData = [];

function toggleUserManagement() {
    const overlay = document.getElementById('userManagementOverlay');
    if (overlay) {
        overlay.classList.toggle('active');
        if (overlay.classList.contains('active')) {
            loadUsersData();
            loadActivityData();
        }
    }
}

async function loadUsersData() {
    try {
        const response = await fetch('/api/admin/users');
        if (response.ok) {
            allUsersData = await response.json();
            updateUserStats();
            renderUsersTable();
        } else {
            showNotification('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng', 'error');
        }
    } catch (error) {
        console.error('Error loading users:', error);
        showNotification('L·ªói khi t·∫£i d·ªØ li·ªáu', 'error');
    }
}

async function loadActivityData() {
    try {
        const response = await fetch('/api/admin/activity');
        if (response.ok) {
            allActivityData = await response.json();
            renderActivityTable();
        } else {
            showNotification('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ho·∫°t ƒë·ªông', 'error');
        }
    } catch (error) {
        console.error('Error loading activity:', error);
        showNotification('L·ªói khi t·∫£i d·ªØ li·ªáu ho·∫°t ƒë·ªông', 'error');
    }
}

function updateUserStats() {
    const totalUsers = allUsersData.length;
    const adminUsers = allUsersData.filter(u => u.role === 'admin').length;
    const activeUsers = totalUsers - adminUsers;

    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('activeUsers').textContent = activeUsers;
    document.getElementById('adminUsers').textContent = adminUsers;
}

function renderUsersTable(users = allUsersData) {
    const tbody = document.getElementById('usersTableBody');
    
    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-users-slash" style="font-size: 36px; opacity: 0.3;"></i>
                    <p style="margin-top: 10px;">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = users.map(user => `
        <tr>
            <td>
                <div class="user-avatar-small">${(user.first_name || user.email)[0].toUpperCase()}</div>
                <strong>${user.first_name || ''} ${user.last_name || ''}</strong>
            </td>
            <td>${user.email}</td>
            <td>
                <span class="role-badge ${user.role || 'user'}">
                    ${user.role === 'admin' ? 'üëë ADMIN' : 'üë§ USER'}
                </span>
            </td>
            <td>${formatDate(user.created_at)}</td>
            <td>
                <button class="action-btn edit" onclick="editUser(${user.id})">
                    <i class="fas fa-edit"></i> S·ª≠a
                </button>
                <button class="action-btn delete" onclick="deleteUser(${user.id}, '${user.email}')">
                    <i class="fas fa-trash"></i> X√≥a
                </button>
            </td>
        </tr>
    `).join('');
}

function filterUsers() {
    const searchTerm = document.getElementById('searchUserInput').value.toLowerCase();
    
    if (!searchTerm) {
        renderUsersTable(allUsersData);
        return;
    }

    const filtered = allUsersData.filter(user => 
        (user.first_name && user.first_name.toLowerCase().includes(searchTerm)) ||
        (user.last_name && user.last_name.toLowerCase().includes(searchTerm)) ||
        user.email.toLowerCase().includes(searchTerm) ||
        (user.role && user.role.toLowerCase().includes(searchTerm))
    );

    renderUsersTable(filtered);
}

function editUser(userId) {
    const user = allUsersData.find(u => u.id === userId);
    if (!user) return;

    const newRole = user.role === 'admin' ? 'user' : 'admin';
    const confirmMsg = `B·∫°n c√≥ ch·∫Øc mu·ªën thay ƒë·ªïi vai tr√≤ c·ªßa ${user.email} th√†nh ${newRole.toUpperCase()}?`;
    
    if (confirm(confirmMsg)) {
        // TODO: Implement actual API call
        showNotification(`ƒê√£ c·∫≠p nh·∫≠t vai tr√≤ cho ${user.email}`, 'success');
        
        // Update local data
        user.role = newRole;
        updateUserStats();
        renderUsersTable();
    }
}

function deleteUser(userId, email) {
    const confirmMsg = `[WARNING] B·∫†N C√ì CH·∫ÆC CH·∫ÆN mu·ªën X√ìA ng∆∞·ªùi d√πng ${email}?\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!`;
    
    if (confirm(confirmMsg)) {
        // TODO: Implement actual API call
        showNotification(`ƒê√£ x√≥a ng∆∞·ªùi d√πng ${email}`, 'success');
        
        // Update local data
        allUsersData = allUsersData.filter(u => u.id !== userId);
        updateUserStats();
        renderUsersTable();
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

// Close overlay when clicking outside
document.addEventListener('click', function(e) {
    const overlay = document.getElementById('userManagementOverlay');
    if (overlay && e.target === overlay) {
        toggleUserManagement();
    }
});

// Close with ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const overlay = document.getElementById('userManagementOverlay');
        if (overlay && overlay.classList.contains('active')) {
            toggleUserManagement();
        }
    }
});

// Activity Management Functions
function renderActivityTable(activities = allActivityData) {
    const tbody = document.getElementById('activityTableBody');
    
    if (activities.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-chart-line" style="font-size: 36px; opacity: 0.3;"></i>
                    <p style="margin-top: 10px;">Ch∆∞a c√≥ d·ªØ li·ªáu ho·∫°t ƒë·ªông</p>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = activities.map(activity => {
        const isOnline = isUserOnline(activity.last_access);
        const loginCountClass = getActivityClass(activity.login_count);
        const model1Class = getActivityClass(activity.model1_usage);
        const model2Class = getActivityClass(activity.model2_usage);
        
        return `
            <tr>
                <td>
                    <div class="user-avatar-small">${(activity.first_name || activity.email)[0].toUpperCase()}</div>
                    <strong>${activity.first_name || ''} ${activity.last_name || ''}</strong>
                </td>
                <td>${activity.email}</td>
                <td><span class="activity-count ${loginCountClass}">${activity.login_count || 0}</span></td>
                <td><span class="activity-count ${model1Class}">${activity.model1_usage || 0}</span></td>
                <td><span class="activity-count ${model2Class}">${activity.model2_usage || 0}</span></td>
                <td>${formatDateTime(activity.last_access)}</td>
                <td>
                    <span class="${isOnline ? 'status-online' : 'status-offline'}">
                        ${isOnline ? 'Online' : 'Offline'}
                    </span>
                </td>
            </tr>
        `;
    }).join('');
}

function getActivityClass(count) {
    if (!count) return 'low';
    if (count >= 10) return 'high';
    if (count >= 5) return 'medium';
    return 'low';
}

function isUserOnline(lastAccess) {
    if (!lastAccess) return false;
    const lastAccessTime = new Date(lastAccess);
    const now = new Date();
    const diffMinutes = (now - lastAccessTime) / (1000 * 60);
    return diffMinutes < 5; // Online if accessed within last 5 minutes
}

function formatDateTime(dateString) {
    if (!dateString) return 'Ch∆∞a truy c·∫≠p';
    const date = new Date(dateString);
    const now = new Date();
    const diffMinutes = Math.floor((now - date) / (1000 * 60));
    
    if (diffMinutes < 1) return 'V·ª´a xong';
    if (diffMinutes < 60) return `${diffMinutes} ph√∫t tr∆∞·ªõc`;
    
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
    
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;
    
    return date.toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function filterActivity() {
    const filter = document.getElementById('activityFilter').value;
    const now = new Date();
    let filtered = allActivityData;
    
    if (filter !== 'all') {
        filtered = allActivityData.filter(activity => {
            if (!activity.last_access) return false;
            
            const lastAccess = new Date(activity.last_access);
            const diffDays = (now - lastAccess) / (1000 * 60 * 60 * 24);
            
            switch(filter) {
                case 'today':
                    return diffDays < 1;
                case 'week':
                    return diffDays < 7;
                case 'month':
                    return diffDays < 30;
                default:
                    return true;
            }
        });
    }
    
    renderActivityTable(filtered);
}

function refreshActivity() {
    loadActivityData();
    showNotification('ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu ho·∫°t ƒë·ªông', 'success');
}

</script>
{% endblock %}
